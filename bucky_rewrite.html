<!DOCTYPE html>
<head>
<script type = "text/javascript">

// mmm... dat polyfill
(function() {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelAnimationFrame = 
          window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
    }
 
    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); }, 
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };
 
    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
}());

// Global Variables
var ctx;
var debugging = 		false;
var blocksize = 		25;
var imageMap;
var GRAVITY = 			0.2;
var UpdateManager = 	new Array();
var	DEAD = 				1;
var	ALIVE = 			2;
var HIT =				3;
var UNHIT = 			4;
var physicsTimer = 		null;
var physExecuteMs = 	7;
var drawExecuteMs = 	16.667;
var physicsDelta = 		null;
var drawTimer = 		null;
var graphics_drawTimer= null;
var drawDelta = 		null;
var drawFps =			60;
var statsDiv;

function Game(x_boundary, y_boundary){
	this.boundary =   function(){};
	this.boundary.x = x_boundary;	// x-coord boundary
	this.boundary.y = y_boundary;	// y-coord boundary
	this.clearColor = "#7ADAE1";			// initial clear color is null
	this.state = null;
	this.drawOffset = 0;
	this.physCorrect = 1;
	this.drawCorrect = 1;
	this.initialized = null;

	this.resetGame = function() {
		window.cancelAnimationFrame(animId);
		begin_game();
	}

	this.clearScreen = function() { 
		ctx.fillStyle = this.clearColor;
		ctx.fillRect(0, 0, this.boundary.x, this.boundary.y);
	}
}

function Timer(end_time, repeat, curr_game) {
	IN_ACTION = 10;
	DONE = 		11;

	this.loop = repeat;
	this.game = curr_game;
	this.time = function(){};
	this.time.current = 0;
	this.time.end = end_time;
	this.status = IN_ACTION;

	UpdateManager.push(this);

	this.update = function() {
		if(this.status == IN_ACTION){
			this.time.current += curr_game.drawCorrect;
		}
		if(this.time.current >= this.time.end){
			if(!this.loop){
				this.status = DONE;
			}
			// if the timer is done, remove it from the UpdateManager
			if(this.loop){
				this.time.current = 0;
			} else {
				for(i = 0; i<UpdateManager.length; i++){
					if(this == UpdateManager[i]){
						UpdateManager.splice(i, 1);
					}
				}
			}
		}
	}
}

function Animation(imageUrlArray, duration, repeat, curr_game){
	IN_ACTION = 10;
	DONE = 		11;

	this.game = curr_game;
	this.status = IN_ACTION;
	this.imageArray = new Array(imageUrlArray.length-1);
	parent = this;

	for(var i = 0; i<imageUrlArray.length; i++){
		this.imageArray[i] = new Image();
		this.imageArray[i].src = imageUrlArray[i];
	}

	this.timer = new Timer(duration, repeat, this.game);

	this.frame = function(){};

	this.frame.current = function(){
		parent.status = parent.timer.status;
		return parent.imageArray[ Math.round( (parent.timer.time.current / parent.timer.time.end) * (parent.imageArray.length-1) ) ];
	}
}

function Player(x_pos, y_pos, curr_game) {
	WALKING = 						1;
	ATTACKING =						2;
	JUMPING =						3;
	this.game = 					curr_game;
	this.action = 					function(){};
	this.draw = 					function(){};
	this.draw.image = 				new Image();
	this.jump = 					function(){};
	this.jump.toggle = 				false;
	this.jump.release = 			true;
	this.position = 				function(){};
	this.position.x = 	 			x_pos;  // x pos
	this.position.y = 	  			y_pos;	// y pos
	this.vel = 						function(){};
	this.vel.x =					0;		// x speed
	this.vel.y =					0;		// y speed
	this.vel.dir = 					function(){};
	this.vel.dir.x = 				1;		// x dir
	this.vel.dir.y = 				1;		// y dir
	this.vel.accel = 				function(){};
	this.vel.accel.x = 				0.1;
	this.vel.accel.y = 				0;
	this.state = 		  			ALIVE; 
	this.image = 		  			new Image();
	this.image.src = 				"images/bucky/bucky_small.gif";
	this.image.width  =   			32;
	this.image.height =   			41;
	this.visible =  				true;
	this.collision = 				function(){};
	this.collision.width_offset = 	10;
	this.collision.height_offset = 	10;
	this.alcohol = 					function(){};
	this.alcohol.drunk = 			false;
	this.alcohol.effect_start = 	5;
	this.alcohol.effect_end = 		5;
	this.animation = 				function(){};
	this.animation.state = 			WALKING;
	this.animation.attack = 		new Animation(new Array(
										"images/bucky/bucky_left.gif", 
										"images/bucky/bucky_normal.gif"), 
										15, 
										true,
										this.game
									);

	this.draw = function() {
		if(this.animation.state == ATTACKING){
			this.draw.image = this.animation.attack.frame.current();
		} else {
			this.draw.image = this.image;
		}
		ctx.drawImage(this.draw.image, Math.floor(this.position.x), Math.floor(this.position.y), this.image.width, this.image.height);
   	}

	this.update = function() {

		// determine acceleration
		if(Controller.shift){
			if(Controller.right){
				if(this.vel.x<0){
					this.vel.accel.x = 0.8;
				} else {
					this.vel.accel.x = 0.1;
				}
			} else if(Controller.left){
				if(this.vel.x>0){
					this.vel.accel.x = -0.8;
				} else {
					this.vel.accel.x = -0.1;
				}
			}
		} else {
			if(Controller.right){
				if(this.vel.x<0){
					this.vel.accel.x = 0.8;
				} else {
					this.vel.accel.x = 0.07;
				}
			} else if(Controller.left){
				if(this.vel.x>0){
					this.vel.accel.x = -0.8;
				} else {
					this.vel.accel.x = -0.07;
				}
			}
		}

		if(Math.abs(this.vel.x) < 0.0001){
			this.vel.x = 0;
		}

		if(Controller.left || Controller.right){
			this.vel.x += this.vel.accel.x //* this.vel.dir.x;
		} else {
			this.vel.x *= 0.70;
		}

		if(!Controller.shift && ((this.vel.x > 2.5 && Controller.right) || (this.vel.x < -2.5 && Controller.left))){
			this.vel.x = (this.vel.x>0) ? 2.5 : -2.5;
			if(this.vel.x>0){
				this.vel.x = 2.5;
			} else if(this.vel.x<0){
				this.vel.x = -2.5
			}
		} else if (Controller.shift && ((this.vel.x > 3.2 && Controller.right) || (this.vel.x < -3.2 && Controller.left))){
			if(this.vel.x>0){
				this.vel.x = 3.2;
			} else if(this.vel.x<0){
				this.vel.x = -3.2
			}
		}

		if(Controller.space && this.jump.toggle){
			this.vel.y = -8.0;
			this.jump.toggle = !this.jump.toggle;
		}

		if(!this.jump.toggle && !Controller.space && this.vel.y < 0 && !this.jump.release){
			this.jump.release = true;
			this.vel.y *= 0.2;
		}

		if(this.vel.y > 0){
			this.jump.toggle = false;
		}

		this.vel.y += GRAVITY * curr_game.physCorrect;

		this.image.src = "images/bucky/bucky_small.gif";

		x_change = this.vel.x * this.vel.dir.x * curr_game.physCorrect;
		y_change = this.vel.y * this.vel.dir.y * curr_game.physCorrect;

		if( (this.position.x >= 350 && this.vel.x >0) || (this.position.x <= 200 && this.vel.x < 0) ){
			// move platforms
			for(i = 0; i<UpdateManager.length; i++){
				if(UpdateManager[i] instanceof Block || UpdateManager[i] instanceof ItemBlock || UpdateManager[i] instanceof Item){
					UpdateManager[i].update(-x_change);
				}
			}

			curr_game.drawOffset -= x_change;

		} else {
			this.position.x += x_change;
		}


		this.position.y += y_change;

		for(i = 0; i<UpdateManager.length; i++){
			if(UpdateManager[i] instanceof Item 
				|| UpdateManager[i] instanceof ItemBlock 
				|| UpdateManager[i] instanceof Block){

				collisionAction(this,UpdateManager[i]);

			}
		}
	}
}

function collisionAction(movable, stationary){

	var movableCenterX = 0;
	var movableCenterY = 0;
	var stationaryCenterX = 0;
	var stationaryCenterY = 0;
	var distanceX = 0;
	var distanceY = 0;
	var minDistanceX = 0;
	var minDistanceY = 0;
	var depthX = 0;
	var depthY = 0;

	movableCenterX = movable.position.x + movable.image.width/2;
	movableCenterY = movable.position.y + movable.image.height/2;
	stationaryCenterX = stationary.position.x + stationary.image.width/2;
	stationaryCenterY = stationary.position.y + stationary.image.height/2;

	distanceX = movableCenterX - stationaryCenterX;
	distanceY = movableCenterY - stationaryCenterY;

	minDistanceX = (movable.image.width-movable.collision.width_offset)/2 + (stationary.image.width-stationary.collision.width_offset)/2;
	minDistanceY = (movable.image.height-movable.collision.height_offset)/2 + (stationary.image.height-stationary.collision.height_offset)/2;

	if(Math.abs(distanceX) >= minDistanceX || Math.abs(distanceY) >= minDistanceY){
		depthX = 0;
		depthY = 0;
	} else {
		depthX = distanceX > 0 ? minDistanceX - distanceX : -minDistanceX - distanceX;
		depthY = distanceY > 0 ? minDistanceY - distanceY : -minDistanceY - distanceY;
	}

	if(movable instanceof Player && stationary instanceof Block){
		if(Math.abs(depthY) < Math.abs(depthX)){ // resolve y first if true
			movable.position.y += depthY;
			if(depthY<0){
				movable.jump.toggle = true;
				movable.jump.release = false;
				movable.vel.y = 0;
			} else {
				movable.vel.y = 0;
			}
		} else { // resolve x first if the first statement was false
			movable.position.x += depthX;
			//this.x_speed = 0;
		}
	} else if (movable instanceof Player && stationary instanceof Item){
		if(depthY != 0 || depthX != 0){
			stationary.visible = false;
			return true;
		} else {
			return false;
		}
	} else if (movable instanceof Player && stationary instanceof ItemBlock){

		if(Math.abs(depthY) < Math.abs(depthX)){ // resolve y first if true
			movable.position.y += depthY;
			if(depthY<0){
				movable.jump.toggle = true;
				movable.jump.release = false;
				movable.vel.y = 0;
			} else {
				movable.vel.y = 0;
				stationary.state = HIT;
			}
		} else { // resolve x first if the first statement was false
			movable.position.x += depthX;
			//this.x_speed = 0;
		}

	}
}

function Block(x_pos, y_pos) {
	this.position = 				function(){};
	this.position.x = 				x_pos;
	this.position.y = 				y_pos;
	this.image = 					new Image();
	this.image.width  = 			25;
	this.image.height = 			25;
	this.visible = 					true;
	this.collision = 				function(){};
	this.collision.width_offset = 	0;
	this.collision.height_offset = 	0;

	this.draw = function() {
		if(debugging){
			if(this.position.x + this.image.width >= 0 && this.position.x <= BuckyGame.boundary.x)
			{
				ctx.strokeStyle = "#FF0000";
				ctx.lineWidth = 1;
				ctx.strokeRect(this.position.x, this.position.y, this.image.width, this.image.height);
			}
		}
	}

	this.update = function(x_change) {
		// update x and y position
		this.position.x += x_change;
	}
}

function Item(x_pos, y_pos, passed_image) {
	this.position = 				function(){};
	this.position.x = 				x_pos;
	this.position.y = 				y_pos;
	this.image = 					passed_image;
	this.image.width  = 			25;
	this.image.height = 			25;
	this.visible = 					true;
	this.collision = 				function(){};
	this.collision.width_offset = 	0;
	this.collision.height_offset = 	0;

	this.draw = function() {
		if(this.visible){
			if(this.position.x + this.image.width >= 0 && this.position.x <= BuckyGame.boundary.x){
				ctx.drawImage(this.image, this.position.x, this.position.y, this.image.width, this.image.height);
			}
		}
		if(debugging){
			if(this.position.x + this.image.width >= 0 && this.position.x <= BuckyGame.boundary.x){
				ctx.strokeStyle = "#0000FF";
				ctx.strokeRect(this.position.x, this.position.y, this.image.width, this.image.height);
			}
			
		}
   	}

	this.update = function(x_change) {
		// update x and y position
		this.position.x += x_change;
	}
}

function ItemBlock(x_pos, y_pos, passed_image, passed_image_second) {
	this.position = 				function(){};
	this.position.x = 				x_pos;
	this.position.y = 				y_pos;
	this.image = 					passed_image;
	this.image.width  = 			25;
	this.image.height = 			25;
	this.state = 					UNHIT;
	this.hit = 						function(){};
	this.hit.image = 				passed_image_second;
	this.collision = 				function(){};
	this.collision.width_offset = 	0;
	this.collision.height_offset = 	0;

	this.draw = function() {
		if(this.state == HIT){
			this.image = this.hit.image;
		}

		if(this.position.x + this.image.width >= 0 && this.position.x <= BuckyGame.boundary.x){
				ctx.drawImage(this.image, Math.floor(this.position.x), this.position.y);
		}

		if(debugging){
			if(this.position.x + this.image.width >= 0 && this.position.x <= BuckyGame.boundary.x){
				ctx.strokeStyle = "#00FF00";
				ctx.strokeRect(this.position.x, this.position.y, this.image.width, this.image.height);
			}
		}
   	}

	this.update = function(x_change) {
		// update x and y position
		this.position.x += x_change;
	}
}

function Button(x_pos, y_pos, b_width, b_height, b_stroke, b_fill, b_text) {
	this.position = 		function(){};
	this.position.x = 		x_pos;
	this.position.y = 		y_pos;
	this.width = 			b_width;
	this.height = 			b_height;
	this.text = 			b_text;
	this.stroke = 			b_stroke;
	this.fill = 			b_fill;

	this.draw = function() {
    	ctx.strokeStyle = this.stroke;
    	ctx.fillStyle = this.fill;

		ctx.lineWidth   = 1;
		ctx.font = '20px Calibri';

		var textWidth = ctx.measureText(this.text).width;
		var textHeight = ctx.measureText(this.text).height;
		var textX = this.position.x + this.width/2 - textWidth/2;


		var lingrad = ctx.createLinearGradient(0,0,0,150);
	    lingrad.addColorStop(0, '#00ABEB');
	    lingrad.addColorStop(0.5, '#fff');
	    lingrad.addColorStop(0.5, '#66CC00');
	    lingrad.addColorStop(1, '#fff');

    	ctx.fillStyle = lingrad;

    	ctx.fillRect(this.position.x, this.position.y, this.width, this.height);
    	ctx.strokeRect(this.position.x, this.position.y, this.width, this.height);

    	if(this.clicked()){
    		ctx.fillStyle = "#FF0000";
    	} else if(this.hover()){
    		ctx.fillStyle = "#00FF00";
    	} else {
    		ctx.fillStyle = this.stroke;
    	}
    	
    	ctx.fillText(this.text, textX, this.position.y + this.height/2 + 7);
   
   	}

	this.hover = function(){
		return Controller.mouse.move.y <= this.position.y+this.height && Controller.mouse.move.y >= this.position.y
		&& Controller.mouse.move.x <= this.position.x+this.width && Controller.mouse.move.x >= this.position.x;
	}

	this.clicked = function(){
		return Controller.mouse.click.y <= this.position.y+this.height && Controller.mouse.click.y >= this.position.y
		&& Controller.mouse.click.x <= this.position.x+this.width && Controller.mouse.click.x >=this.position.x && Controller.mouse.click.left;
	}
}

// tile collection, used for sets of random-use tiles
function TileCollection(imageUrlArray) {
	this.tileArray = new Array(imageUrlArray.length-1);

	for(i = 0; i<imageUrlArray.length; i++){
		this.tileArray[i] = new Image();
		this.tileArray[i].src = imageUrlArray[i];
	}
	
	this.getRandomTile = function() {
		return(this.tileArray[Math.floor(Math.random()*this.tileArray.length)])
	}
}

// used to implement autotiling, making map creating much easier
function TileSet(imageUrlArray, typeNum, tileType) {
	// starts off with 9 set, ends with 4 set
	// topleft, topmiddle, topright, middleleft, middlemiddle, middleright, bottomleft, bottommiddle, bottomright
	// topsingle, leftsingle, rightsingle, bottomsingle
	this.tileArray = new Array(imageUrlArray.length-1);
	this.type = tileType;
	this.num = typeNum;

	for(i = 0; i<imageUrlArray.length; i++){
		this.tileArray[i] = new Image();
		this.tileArray[i].src = imageUrlArray[i];
	}


	this.arrayCompare = function(array1, array2){
		for(i = 0; i<array1.length; i++){
			for(k = 0; k<array1[i].length; k++){
				if( ( array1[i][k] != array2[i][k] ) && ( array2[i][k] != 9 ) ) return false;
			}
		}
		return true;
	}


	this.getTile = function(surrounding){
		// get sent a 3x3 array of the tiles around current spot (this one being the middle)

		if(surrounding != null){
			for(i = 0; i<surrounding.length; i++){
				for(k = 0; k<surrounding[1].length; k++){
					if(surrounding[i][k] != this.num){
						surrounding[i][k] = 0;
					}
				}
			}
		}

		if(surrounding != null && this.num != surrounding[1][1]) return false;

		if(this.type == "full"){
			if( 	   this.arrayCompare(surrounding,  [[9,0,9],[0,this.num,this.num],[9,this.num,9]] ) ){ // top left
				return this.tileArray[0];
			} else if( this.arrayCompare(surrounding,  [[9,0,9],[this.num,this.num,this.num],[9,this.num,9]] ) ){ // top middle
				return this.tileArray[1];
			} else if( this.arrayCompare(surrounding,  [[9,0,9],[this.num,this.num,0],[9,this.num,9]] ) ){ // top right
				return this.tileArray[2];
			} else if( this.arrayCompare(surrounding,  [[9,this.num,9],[0,this.num,this.num],[9,this.num,9]] ) ){ // middle left
				return this.tileArray[3];
			} else if( this.arrayCompare(surrounding,  [[9,this.num,9],[this.num,this.num,this.num],[9,this.num,9]] ) ){ // middle middle
				return this.tileArray[4];
			} else if( this.arrayCompare(surrounding,  [[9,this.num,9],[this.num,this.num,0],[9,this.num,9]] ) ){ // middle right
				return this.tileArray[5];
			} else if( this.arrayCompare(surrounding,  [[9,this.num,9],[0,this.num,this.num],[9,0,9]] ) ){ // bottom left
				return this.tileArray[6];
			} else if( this.arrayCompare(surrounding,  [[9,this.num,9],[this.num,this.num,this.num],[9,0,9]] ) ){ // bottom middle
				return this.tileArray[7];
			} else if( this.arrayCompare(surrounding,  [[9,this.num,9],[this.num,this.num,0],[9,0,9]] ) ){ // bottom right
				return this.tileArray[8];
			} else if( this.arrayCompare(surrounding,  [[9,0,9],[0,this.num,0],[9,this.num,9]] ) ){ // top single
				return this.tileArray[9];
			} else if( this.arrayCompare(surrounding,  [[9,0,9],[0,this.num,this.num],[9,0,9]] ) ){ // left single
				return this.tileArray[10];
			} else if( this.arrayCompare(surrounding,  [[9,0,9],[this.num,this.num,0],[9,0,9]] ) ){ // right single
				return this.tileArray[11];
			} else if( this.arrayCompare(surrounding,  [[9,this.num,9],[0,this.num,0],[9,0,9]] ) ){ // bottom single
				return this.tileArray[12];
			} else if( this.arrayCompare(surrounding,  [[9,0,9],[this.num,this.num,this.num],[9,0,9]] ) ){ // middle single horizontal
				return this.tileArray[13];
			}  else if( this.arrayCompare(surrounding, [[9,this.num,9],[0,this.num,0],[9,this.num,9]] ) ){ // middle single vertical
				return this.tileArray[14];
			} else {											  	  // middle middle
				return this.tileArray[4];
			}

		} else if(this.type == "dual"){
			if( 	   this.arrayCompare(surrounding, [[9,0,9],[9,this.num,9],[9,this.num,9]])){
				return this.tileArray[0];							  // top
			} else if( this.arrayCompare(surrounding, [[9,0,9],[9,this.num,9],[9,0,9]])){						
				return this.tileArray[0];					  		  // bottom
			} else {
				return this.tileArray[1];
			}

		} else if(this.type == "single"){
			return this.tileArray[0];
		}
	}
}

function Parallax(imageSrc, percentMovementSpeed, currGame){
	this.image = new Image();
	this.image.src = imageSrc;
	this.multiplier = percentMovementSpeed;
	this.game = currGame;

	this.draw = function(){

		x_draw1 = Math.round(this.game.drawOffset * this.multiplier%this.image.width-this.image.width);
		x_draw2 = Math.round(this.game.drawOffset * this.multiplier%this.image.width);
		x_draw3 = Math.round(this.game.drawOffset * this.multiplier%this.image.width+this.image.width);

		if(x_draw1 < this.game.boundary.x && x_draw1+this.image.width >= 0){
			ctx.drawImage(this.image, x_draw1, 0);
		}
		if(x_draw2 < this.game.boundary.x && x_draw2+this.image.width >= 0){
			ctx.drawImage(this.image, x_draw2, 0);
		}
		if(x_draw3 < this.game.boundary.x && x_draw3+this.image.width >= 0){
			ctx.drawImage(this.image, x_draw3, 0);
		}
	}
}

function Control() {
	this.keyboard = 			function(){};
	this.keyboard.space = 		false;
	this.keyboard.shift = 		false;
	this.keyboard.left = 		false;
	this.keyboard.right = 		false;
	this.keyboard.up = 			false;
	this.keyboard.down = 		false;
	this.mouse = 				function(){};
	this.mouse.click = 			function(){};
	this.mouse.click.left = 	false;
	this.mouse.click.right = 	false;
	this.mouse.click.middle = 	false;
	this.mouse.click.x = 		null;
	this.mouse.click.y = 		null;
	this.mouse.move = 			function(){};
	this.mouse.move.x = 		null;
	this.mouse.move.y = 		null;
}

function mouse_move(event) {
	Controller.mouse.move.x = event.offsetX?(event.offsetX):event.pageX-document.getElementById("draw_canvas").offsetLeft;
	Controller.mouse.move.y = event.offsetY?(event.offsetY):event.pageY-document.getElementById("draw_canvas").offsetTop;
	// x and y now hold the position onscreen of the mouse after the mouse was moved
}

function mouse_press(event) {
	Controller.mouse.click.x = event.offsetX?(event.offsetX):event.pageX-document.getElementById("draw_canvas").offsetLeft;
	Controller.mouse.click.y = event.offsetY?(event.offsetY):event.pageY-document.getElementById("draw_canvas").offsetTop;
	// x and y now hold the position onscreen of the mouse click
}

function key_event(event) {
	switch(event.keyCode){
		case 32:				Controller.space = true;	break;		// space
		case 16:				Controller.shift = true;	break;		// shift
		case 39: case 68:		Controller.right = true;	break;		// right
		case 37: case 65:		Controller.left = true;		break;		// left
		case 38: case 87:		Controller.up = true; 		break;		// up
		case 40: case 83:		Controller.down = true;		break;		// down
	}
}

function key_event_up(event) {
	switch(event.keyCode){
		case 32:				Controller.space = false;	break;		// space
		case 16:				Controller.shift = false;	break;		// shift
		case 39: case 68:		Controller.right = false;	break;		// right
		case 37: case 65:		Controller.left = false;	break;		// left
		case 38: case 87:		Controller.up = false; 		break;		// up
		case 40: case 83:		Controller.down = false;	break;		// down
	}
}

function mouse_up(event) {
	switch(event.which){
		case 1: Controller.mouse.click.left =   false; break;
		case 2: Controller.mouse.click.middle = false; break;
		case 3: Controller.mouse.click.right =  false; break;
	}
}

function mouse_down(event) {
	switch(event.which){
		case 1: Controller.mouse.click.left =   true; break;
		case 2: Controller.mouse.click.middle = true; break;
		case 3: Controller.mouse.click.right =  true; break;
	}
}

function mouse_scroll(event) {
	var evt=window.event || event //equalize event object
	var delta=evt.detail? evt.detail*(-120) : evt.wheelDelta //check for detail first so Opera uses that instead of wheelDelta
	// delta now holds the amount that the wheel was scrolled
}

function page_load() {
	var mousewheelevt=(/Firefox/i.test(navigator.userAgent))? "DOMMouseScroll" : "mousewheel";
	if (document.attachEvent){
		document.attachEvent("on"+mousewheelevt, function(e) {mouse_scroll(e)}, false);
	}else if (document.addEventListener){
		document.addEventListener(mousewheelevt, function(e) {mouse_scroll(e)}, false);
	}
	begin_game();
}

function begin_game() {

	UpdateManager = new Array();

	statsDiv = document.getElementById("fps");

	GrassTileset  = new TileSet(new Array(
		"images/grass_tileset/grass_top_left.png", 
		"images/grass_tileset/grass_top_middle.png", 
		"images/grass_tileset/grass_top_right.png", 
		"images/grass_tileset/grass_middle_left.png", 
		"images/grass_tileset/ground_tile.png", 
		"images/grass_tileset/grass_middle_right.png", 
		"images/grass_tileset/grass_bottom_left.png", 
		"images/grass_tileset/grass_bottom_middle.png", 
		"images/grass_tileset/grass_bottom_right.png", 
		"images/grass_tileset/grass_top_single.png", 
		"images/grass_tileset/grass_left_single.png", 
		"images/grass_tileset/grass_right_single.png", 
		"images/grass_tileset/grass_bottom_single.png", 
		"images/grass_tileset/grass_middle_single_horizontal.png", 
		"images/grass_tileset/grass_middle_single_vertical.png"),
		1,
		"full");

	RockTileset = new TileSet( new Array(
		"images/rock_tileset/platform.png", 
		"images/rock_tileset/platform_underneath.png"), 
		2, 
		"dual");

	SpikeTileset = new TileSet( new Array(
		"images/spike_tileset/spike_pit.png", 
		"images/spike_tileset/spike_lower.png"), 
		4, 
		"dual");

	BeerTileset = new TileSet( new Array(
		"images/items/beer_mug.png"), 
		3, 
		"single");

	ItemBlockTileset = new TileSet( new Array(
		"images/items/item_block.png",
		"images/items/item_block_hit.png"), 
		6, 
		"single");

	collideTypes = new Array(GrassTileset, RockTileset);
	itemTypes = new Array(BeerTileset);

	TilesetArrays = new Array(GrassTileset, RockTileset, SpikeTileset);

	var canvas = document.getElementById("draw_canvas");
	ctx = canvas.getContext("2d");

	Controller = new Control();
	BuckyGame = new Game(800, 600);
	Buckingham = new Player(225, 300, BuckyGame);

	PlayButton = new Button(500, 450, 100, 30, "#000000", "#CCCCCC", "Play Game");
	ResetButton = new Button(650, 10, 120, 30, "#000000", "#CCCCCC", "Reset Game");

	Background = new Parallax("images/backgrounds/test_background.jpg", 0.3, BuckyGame);

	// 0 = blank space
	// 1 = grass
	// 2 = blue platform
	// 3 = beer
	// 4 = spike pit
	// 5 = enemy
	map = [
	//1  2  3  4  5  6  7  8  9  0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5  6  7  8  9  0
	 [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
	 [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
	 [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 3, 3, 3, 0, 0, 6, 6, 6, 0, 0, 2, 6, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0],
	 [2, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 4, 4, 4, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0],
	 [2, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 4, 4, 4, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0],
	 [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4, 4, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0],
	 [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4, 4, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0],
	 [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4, 4, 4, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0]
	];

	imageMap = new Array(map.length);

	for(i = 0; i<map.length; i++){
		imageMap[i] = new Array(map[0].length);
	}

	// process map file for use in drawing, and logic segments
	for(var i = 0; i<map.length; i++){
		for(var k = 0; k<map[i].length; k++){

			// process tiles for producing an image map
			for(j = 0; j<TilesetArrays.length; j++){
				var checkArray =   [  [  			0		   , (i-1>=0)?map[i-1][k]:0	 	    ,  			0		   				   ],
									  [ (k-1>=0)?map[i][k-1]:0 ,          map[i][k] 	      	, (k+1<map[i].length)?(map[i][k+1]):0  ],
									  [  			0		   , (i+1<map.length)?map[i+1][k]:0 ,  			0		   				   ]  ];
				
				var result = TilesetArrays[j].getTile(checkArray);

				if(result){
					imageMap[i][k] = result;
				}
			}
			if(imageMap[i][k] == undefined) imageMap[i][k] = null;


			/***********************************************
			 PROCESS MAP FILE FOR COLLIDING BLOCKS AND ITEMS
			 ***********************************************/
			for(j = 0; j<collideTypes.length; j++){
				if(map[i][k] == collideTypes[j].num){
					UpdateManager.push(new Block(k*blocksize, i*blocksize));
				}
			}
			for(j = 0; j<itemTypes.length; j++){
				if(map[i][k] == itemTypes[j].num){
					UpdateManager.push(new Item(k*blocksize, i*blocksize, itemTypes[j].getTile()));
				}
			}

			/************************************************
			 PROCESS INDIVIDUAL TILE ITEMS THAT AREN'T IN
			 A COLLECTION
			 ************************************************/
			 if(map[i][k] == ItemBlockTileset.num){
			 	UpdateManager.push(new ItemBlock(k*blocksize, i*blocksize, ItemBlockTileset.tileArray[0], ItemBlockTileset.tileArray[1]));
			 }
		}	
	}
	caller();
}

function caller(){
	physInterval = setInterval(physics, physExecuteMs);
	if(debugging || true){
		statsInterval = setInterval(stats, 200);
	}
	draw_world();
}

function physics(){

	if(ResetButton.clicked()){
		clearInterval(statsInterval);
		clearInterval(physInterval);
		BuckyGame.resetGame();
	}

	/******************************************
	 PHYSICS TIMER, USED FOR ACCURATE MOVEMENT
	 ******************************************/
	if(physicsTimer == null){
		physicsTimer = new Date().getTime();
	} else {
		physicsDelta = new Date().getTime()-physicsTimer;
		physicsTimer = new Date().getTime();
		BuckyGame.physCorrect = BuckyGame.physCorrect * (4/5) + physicsDelta/physExecuteMs * (1/5);
		if(BuckyGame.physCorrect > 2) BuckyGame.physCorrect = 2;
	}
	// print stats out to the screen
	Buckingham.update();

}

function stats() {
	statsDiv.innerHTML = 
		"Physics Delta: " 
		+ physicsDelta 
		+ "<br />PhysCorrect: " 
		+ ((BuckyGame.physCorrect>=2) ? "<span style='color: red;'>":"")
		+ BuckyGame.physCorrect.toFixed(2) 
		+ ((BuckyGame.physCorrect>=2) ? "</span>":"")
		+ "<br />drawCorrect: "
		+ BuckyGame.drawCorrect.toFixed(2)
		+ "<br />drawFPS: " 
		+ drawFps.toFixed(2)
		+ "<br />BuckyAccel : "
		+ Buckingham.vel.x;
}


function draw_world() { 

	if(graphics_drawTimer == null){
		graphics_drawTimer = new Date().getTime();
	} else {
		drawDelta = new Date().getTime()-graphics_drawTimer;
		graphics_drawTimer = new Date().getTime(); 
		drawFps = drawFps * (4/5) + 1000/drawDelta * 1/5;
		BuckyGame.drawCorrect = BuckyGame.drawCorrect * (4/5) + drawDelta/drawExecuteMs * (1/5);
		if(BuckyGame.drawCorrect > 2) BuckyGame.drawCorrect = 2;
	}
	
	BuckyGame.clearScreen();

	Background.draw();

	// draw tile image map
	for(var i = 0; i<map.length; i++){
		for(var k = 0; k<map[i].length; k++){
			if( (k+1)*blocksize+BuckyGame.drawOffset > 0 && (k-1)*blocksize+BuckyGame.drawOffset<BuckyGame.boundary.x){
				if(imageMap[i][k] != null) ctx.drawImage(imageMap[i][k], Math.floor(k*blocksize+BuckyGame.drawOffset), Math.floor(i*blocksize));
			}
		}
	}

	for(var i = 0; i<UpdateManager.length; i++){
		if(UpdateManager[i] instanceof Block || UpdateManager[i] instanceof ItemBlock || UpdateManager[i] instanceof Item){
			UpdateManager[i].draw();
		} else if (UpdateManager[i] instanceof Timer){
			UpdateManager[i].update();
		}
	}

	Buckingham.draw();
	ResetButton.draw();

	animId = window.requestAnimationFrame(draw_world);
	
}


window.addEventListener('keydown',key_event,true);
window.addEventListener('keyup',key_event_up,true);
window.addEventListener('mouseup', mouse_up, false);
window.addEventListener('mousedown', mouse_down, false);

</script> 
</head>
<body style="overflow: hidden;"  onload="page_load()">

<canvas onmousemove="mouse_move(event)" onmousedown="mouse_press(event)" id="draw_canvas" width="800" height="600" tabindex="1"></canvas>

<div id="fps" style="width: 400px; display: inline-block; vertical-align: top;"></div>

<script type="text/javascript">
	gameCanvas = document.getElementById("draw_canvas");
  	document.getElementById("draw_canvas").focus();
</script>

</body>
</html>

